#!/bin/bash

# Check to make sure that dmc is awesome
check() {
	cd "$1" || return 0
	if git rev-parse --show-toplevel &>/dev/null; then
			stat="$(git diff --shortstat)"
			[[ ${#stat} > 0 ]] && printf '%s|%s\n' "${1/$HOME/}" "$stat"
			return 1
	fi
	return 0
}

crawl() {
	for i in "$1/*"; do
		cd "$i" 2>/dev/null || continue
		check "$i" && crawl "$i" &
	done
}

handle_results() {
	while read -r url; do
		cd "$HOME${url%%\ *}"
		"$TERMINAL" -e git commit -a -s --verbose
	done
}

# =^.^=
if [[ $1 == "wc" ]]; then
	cat <(crawl ~/code) <(check "$XDG_CONFIG_HOME") | wc -l
else
	cat <(check "$XDG_CONFIG_HOME") <(crawl ~/code) | column -s '|' -t | dmenu -p "Commit: " | handle_results 
	/usr/local/share/hwwm/gitbar commit
	/usr/local/share/hwwm/gitbar push	
fi
