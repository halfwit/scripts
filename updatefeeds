#!/bin/sh

## Script to fetch RSS + atom feeds 
## See ://gist.github.com/halfwit/d5251e2b0e58c1f5199c49dfbf836e5d for sample xslt files to use
RSS="$XDG_DATA_HOME"/rss
TMP="$(mktemp -d )"

build_folders() {
	read -r feed
	while read -r link title; do
		if ! test -f "$RSS/$feed/*read/$title"; then
			mkdir -p "$(dirname "$RSS/$feed/unread/$title")"
			echo "$link" > "$RSS/$feed/unread/$title"
		fi
	done
}

fetch() {
	cd "$TMP"
	curl -sLOK "$XDG_DATA_HOME"/feedurls
}

parse() {
	xml tr "$XDG_DATA_HOME"/xslt/"$(xml el "$TMP"/* | head -n 1)".xslt "$TMP"/* | build_folders
}

fetch && wait
parse

# you can comment this out, it's just for my status bar
if ls -d "$RSS"/*/unread/* >/dev/null; then 
	dirname "$RSS"/*/unread/* | wc -l > "$XDG_RUNTIME_DIR/statusbar/rss"
fi

rm -rf "$TMP"
