#!/bin/bash
# Branches should be handled with much more care, do not use for branches

check() {
	cd "$1" || return 0
	if git  rev-parse --is-inside-work-tree &>/dev/null; then
		case "$(git status | sed -n 2p)" in
			*ahead*) printf '%s\n' "${1/$HOME/}" 
					return 1 ;;
		esac	
	fi
	return 0
}

crawl() {
		for i in $1/*; do
<<<<<<< HEAD
				cd "$i" 2>/dev/null || continue
=======
				if test -d "$i" 2>/dev/null; then
						cd "$i" || return 0
				else
						continue
				fi
>>>>>>> 35c5ae606bf2d05d345ac8cf67928591c6bdbe48
				check "$i" && crawl "$i" &
		done
}

handle_results() {
		while read -r url; do
<<<<<<< HEAD
				cd "$HOME${url%%\ *}" || continue
				st -g 60x1+20+20 -c float -e git push
						:
=======
				cd "$HOME${url%%\ *}" || return 0
				st -g 60x1+20+20 -t float -e git push
>>>>>>> 35c5ae606bf2d05d345ac8cf67928591c6bdbe48
		done
}

# =^.^=
if [[ $1 == "wc" ]]; then
	cat <(crawl ~/code) <(check "$XDG_CONFIG_HOME") | wc -l
else
	cat <(crawl ~/code) <(check "$XDG_CONFIG_HOME") | dmenu -p "Push repo: " | handle_results 
	/usr/local/share/hwwm/gitbar push &
fi
